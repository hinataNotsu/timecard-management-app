rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function orgData(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)).data;
    }
    function signedIn() {
      return request.auth != null;
    }

    function currentUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isNotDeleted() {
      let userData = currentUserData();
      return !('deleted' in userData) || userData.deleted != true;
    }

    function isMember(orgId) {
      let userData = currentUserData();
      return 'organizationIds' in userData &&
             userData.organizationIds != null &&
             userData.organizationIds.hasAny([orgId]);
    }

    function isManage() {
      return currentUserData().isManage == true;
    }
    
    function submissionAllowed(orgId, shiftTs) {
      let o = orgData(orgId);
      let enforced = ("shiftSubmissionEnforced" in o) && (o.shiftSubmissionEnforced == true);
      let days = ("shiftSubmissionMinDaysBefore" in o) ? o.shiftSubmissionMinDaysBefore : 0;
      // 管理者は常に許可 / 無効時は許可 / 有効時は request.time + days <= shiftTs
      return isManage() || !enforced || (request.time + duration.value(days, 'd') <= shiftTs);
    }
    
    // ユーザーコレクション
    match /users/{userId} {
      // 読み取り: 自分 or （同一組織のメンバーのユーザー）
      allow read: if signedIn() && isNotDeleted() && (
        request.auth.uid == userId || (
          // 対象ユーザーの所属組織に、現在ユーザーのcurrentOrganizationIdが含まれている
          ('organizationIds' in resource.data) &&
          (currentUserData().currentOrganizationId != null) &&
          resource.data.organizationIds.hasAny([currentUserData().currentOrganizationId]) &&
          // 自分自身もその組織のメンバーであること
          isMember(currentUserData().currentOrganizationId)
        )
      );

      // 作成: 自分のドキュメントのみ
      allow create: if signedIn() && request.auth.uid == userId;

      // 更新: 自分のドキュメント もしくは 管理者による所属組織の解除のみ許可
      allow update: if signedIn() && (
        // 自分自身の更新は許可（削除済みでない場合のみ）
        (request.auth.uid == userId && isNotDeleted()) || (
          // 管理者による、現在の組織からターゲットユーザーを外す更新のみ許可
          isManage() &&
          isNotDeleted() &&
          currentUserData().currentOrganizationId != null &&
          isMember(currentUserData().currentOrganizationId) &&
          // 対象ユーザーがその組織に所属していること
          ('organizationIds' in resource.data) &&
          resource.data.organizationIds != null &&
          resource.data.organizationIds.hasAny([currentUserData().currentOrganizationId]) &&
          // 変更はorganizationIdsのみに限定
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['organizationIds']) &&
          // サイズは1だけ減少（=追加は不可）
          request.resource.data.organizationIds.size() == resource.data.organizationIds.size() - 1 &&
          // 更新後に currentOrganizationId が含まれていないこと（=その組織からの除外）
          !request.resource.data.organizationIds.hasAny([currentUserData().currentOrganizationId])
        )
      );
    }
    
    // 組織コレクション
    match /organizations/{organizationId} {
      // 認証済みユーザーは作成可能（削除済みでない場合のみ）
      allow create: if signedIn() && isNotDeleted();
      
      // 認証済みユーザーは読み取り可能（組織IDを確認するため）、削除済みでない場合のみ
      allow read: if signedIn() && isNotDeleted();
      
      // 自分が管理者の組織は更新・削除可能（削除済みでない場合のみ）
      allow update, delete: if signedIn() &&
                               isNotDeleted() &&
                               isMember(organizationId) &&
                               isManage();

      // 組織配下: メンバー個別設定（例: 交通費）
      match /members/{userId} {
        // 読み取り: 管理者かつ同一組織のメンバー、削除済みでない場合のみ
        allow read: if signedIn() && isNotDeleted() && isMember(organizationId) && isManage();
        // 書き込み: 管理者かつ同一組織のメンバー、削除済みでない場合のみ
        allow create, update, delete: if signedIn() && isNotDeleted() && isMember(organizationId) && isManage();
      }
    }
    
    // シフトコレクション
    match /shifts/{shiftId} {
      // 読み取り: ログイン済み & 同じ組織のメンバー & 削除済みでない
      allow read: if signedIn() && isNotDeleted() && isMember(resource.data.organizationId);

      // 作成: ログイン済み & 所属組織のシフト & 自分のuserRef & 削除済みでない
      // デバッグ用に条件を分けて記述
      allow create: if signedIn() &&
              isNotDeleted() &&
              request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) &&
              isMember(request.resource.data.organizationId) &&
              submissionAllowed(request.resource.data.organizationId, request.resource.data.date);

      // 更新:
      // - 管理者: 同一組織内なら更新可（承認/却下操作を想定）& 削除済みでない
      // - 本人: statusがpendingの間のみ、かつstatus/organizationId/userRefを変更不可 & 削除済みでない
      allow update: if signedIn() && isNotDeleted() && isMember(resource.data.organizationId) && (
                      isManage() || (
                        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) &&
                        (!('status' in resource.data) || resource.data.status == 'pending') &&
                        request.resource.data.status == resource.data.status &&
                        request.resource.data.organizationId == resource.data.organizationId &&
                        request.resource.data.userRef == resource.data.userRef &&
                        submissionAllowed(resource.data.organizationId, request.resource.data.date)
                      )
                    );

      // 削除: 管理者は可。本人はstatusがpendingのときのみ可（未設定はpending扱い）& 削除済みでない
      allow delete: if signedIn() && isNotDeleted() && isMember(resource.data.organizationId) && (
                      isManage() || (
                        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) &&
                        (!('status' in resource.data) || resource.data.status == 'pending') &&
                        submissionAllowed(resource.data.organizationId, resource.data.date)
                      )
                    );
    }
    
    // タイムカードコレクション
    match /timecards/{timecardId} {
      // 自分が所属する組織のタイムカードは読み取り可能 & 削除済みでない
      allow read: if signedIn() && isNotDeleted() && isMember(resource.data.organizationId);
      
      // アルバイトは自分のタイムカードを作成可能（status=draftのみ）& 削除済みでない
      allow create: if signedIn() && 
                       isNotDeleted() &&
                       request.auth.uid == request.resource.data.userId &&
                       isMember(request.resource.data.organizationId) &&
                       request.resource.data.status == 'draft';
      
      // アルバイトは自分のタイムカードを以下の条件で更新可能 & 削除済みでない
      // - status=draftの間は自由に更新可能（statusをdraftからpendingに変更することも含む）
      // - rejectedからdraftへの巻き戻しも可能
      // - 打刻フィールド（clockInAt, clockOutAt, breakStartAt, breakEndAt, updatedAt）のみの更新は、statusに関係なく可能
      allow update: if signedIn() && 
                       isNotDeleted() &&
                       request.auth.uid == resource.data.userId &&
                       isMember(resource.data.organizationId) &&
                       (
                         (resource.data.status == 'draft') ||
                         (resource.data.status == 'rejected' && request.resource.data.status == 'draft') ||
                         (
                           // 打刻フィールドのみの変更を許可（statusは変更しない）
                           request.resource.data.status == resource.data.status &&
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['clockInAt', 'clockOutAt', 'breakStartAt', 'breakEndAt', 'updatedAt'])
                         )
                       );
      
      // 管理者は同じ組織のタイムカードを更新・削除可能（承認/却下を含む）& 削除済みでない
      allow update, delete: if signedIn() && isNotDeleted() && isMember(resource.data.organizationId) && isManage();
      allow update, delete: if signedIn() && isMember(resource.data.organizationId) && isManage();
    }
  }
}
