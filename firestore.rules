rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function orgData(orgId) {
      return get(/databases/$(database)/documents/organizations/$(orgId)).data;
    }
    function signedIn() {
      return request.auth != null;
    }

    // ユーザーのドキュメントを取得する関数
    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // ユーザーデータを安全に取得（ドキュメントがない場合は空のマップを返す）
    function currentUserData() {
      let doc = getUserDoc();
      return doc != null ? doc.data : {};
    }

    function isMember(orgId) {
      let userData = currentUserData();
      return 'organizationIds' in userData &&
             userData.organizationIds != null &&
             userData.organizationIds.hasAny([orgId]);
    }

    function isManage() {
      // currentUserData()が空の場合(新規時)はfalseになるので安全
      let userData = currentUserData();
      return 'isManage' in userData && userData.isManage == true;
    }
    
    function submissionAllowed(orgId, shiftTs) {
      let o = orgData(orgId);
      let enforced = ("shiftSubmissionEnforced" in o) && (o.shiftSubmissionEnforced == true);
      let days = ("shiftSubmissionMinDaysBefore" in o) ? o.shiftSubmissionMinDaysBefore : 0;
      // 管理者は常に許可 / 無効時は許可 / 有効時は request.time + days <= shiftTs
      return isManage() || !enforced || (request.time + duration.value(days, 'd') <= shiftTs);
    }
    
    // ユーザーコレクション
    match /users/{userId} {
      // 読み取り: 自分 or （同一組織のメンバーのユーザー）
      allow read: if signedIn() && (
        request.auth.uid == userId || (
          // 対象ユーザーの所属組織に、現在ユーザーのcurrentOrganizationIdが含まれている
          ('organizationIds' in resource.data) &&
          (currentUserData().currentOrganizationId != null) &&
          resource.data.organizationIds.hasAny([currentUserData().currentOrganizationId]) &&
          // 自分自身もその組織のメンバーであること
          isMember(currentUserData().currentOrganizationId)
        )
      );

      // 作成: 誰でも（signedInのみ）
      allow create: if signedIn();

      // 更新: 自分のドキュメント もしくは 管理者による所属組織の追加・解除を許可
      allow update: if signedIn() && (
        // 自分自身の更新は許可
        (request.auth.uid == userId) || (
          // 管理者による組織メンバーの追加・削除を許可
          isManage() &&
          currentUserData().currentOrganizationId != null &&
          isMember(currentUserData().currentOrganizationId) &&
          // 変更はorganizationIds と currentOrganizationId のみに限定
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['organizationIds', 'currentOrganizationId', 'updatedAt']) &&
          (
            // パターン1: organizationIds に管理者の組織を追加する場合
            (
              request.resource.data.organizationIds.size() == resource.data.organizationIds.size() + 1 &&
              request.resource.data.organizationIds.hasAny([currentUserData().currentOrganizationId]) &&
              !resource.data.organizationIds.hasAny([currentUserData().currentOrganizationId])
            ) ||
            // パターン2: organizationIds から管理者の組織を削除する場合
            (
              ('organizationIds' in resource.data) &&
              resource.data.organizationIds != null &&
              resource.data.organizationIds.hasAny([currentUserData().currentOrganizationId]) &&
              request.resource.data.organizationIds.size() == resource.data.organizationIds.size() - 1 &&
              !request.resource.data.organizationIds.hasAny([currentUserData().currentOrganizationId])
            )
          )
        )
      );
    }
    
    // 組織コレクション
    match /organizations/{organizationId} {
            // 申請一覧（requestsサブコレクション）
            match /requests/{requestId} {
              // 読み取り: 管理者のみ
              allow read: if signedIn() && isMember(organizationId) && isManage();
              // 作成: 一時的に誰でも許可（認証情報切り分け用）
              allow create: if true;
              // 削除: 管理者のみ
              allow delete: if signedIn() && isMember(organizationId) && isManage();
            }
        // 申請リスト: permissionList[] フィールド
        // permissionList の読み書きは authenticated user なら許可
        allow read, update: if signedIn();
      // 認証済みユーザーは作成可能
      allow create: if signedIn();
      
      // 認証済みユーザーは読み取り可能（組織IDを確認するため）
      allow read: if signedIn();
      
      // 自分が管理者の組織は更新・削除可能
      allow update, delete: if signedIn() &&
                               isMember(organizationId) &&
                               isManage();

      // 組織配下: メンバー個別設定（例: 交通費）
      match /members/{userId} {
        // 読み取り: 同一組織のメンバー かつ (管理者 または 本人)
        allow read: if signedIn() && isMember(organizationId) && (isManage() || request.auth.uid == userId);
        // 申請（create）は認証済みユーザーなら誰でも許可
        allow create: if signedIn();
        // 更新・削除は管理者かつ同一組織のメンバーのみ
        allow update, delete: if signedIn() && isMember(organizationId) && isManage();
      }
    }
    
    // シフトコレクション
    match /shifts/{shiftId} {
      // 読み取り: ログイン済み & 同じ組織のメンバー
      allow read: if signedIn() && isMember(resource.data.organizationId);

      // 作成: ログイン済み & 所属組織のシフト & (自分のuserRef or 管理者)
      // デバッグ用に条件を分けて記述
      allow create: if signedIn() &&
              isMember(request.resource.data.organizationId) &&
              (
                request.resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) ||
                isManage()
              ) &&
              submissionAllowed(request.resource.data.organizationId, request.resource.data.date);

      // 更新:
      // - 管理者: 同一組織内なら更新可（承認/却下操作を想定）
      // - 本人: statusがpendingの間のみ、かつstatus/organizationId/userRefを変更不可
      allow update: if signedIn() && isMember(resource.data.organizationId) && (
                      isManage() || (
                        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) &&
                        (!('status' in resource.data) || resource.data.status == 'pending') &&
                        request.resource.data.status == resource.data.status &&
                        request.resource.data.organizationId == resource.data.organizationId &&
                        request.resource.data.userRef == resource.data.userRef &&
                        submissionAllowed(resource.data.organizationId, request.resource.data.date)
                      )
                    );

      // 削除: 管理者は可。本人はstatusがpendingのときのみ可（未設定はpending扱い）
      allow delete: if signedIn() && isMember(resource.data.organizationId) && (
                      isManage() || (
                        resource.data.userRef == /databases/$(database)/documents/users/$(request.auth.uid) &&
                        (!('status' in resource.data) || resource.data.status == 'pending') &&
                        submissionAllowed(resource.data.organizationId, resource.data.date)
                      )
                    );
    }
    
    // タイムカードコレクション
    match /timecards/{timecardId} {
      // 自分が所属する組織のタイムカードは読み取り可能
      allow read: if signedIn() && isMember(resource.data.organizationId);
      
      // アルバイトは自分のタイムカードを作成可能（status=draftのみ）
      // 管理者は組織内の任意のユーザーのタイムカードを作成可能
      allow create: if signedIn() && 
                       isMember(request.resource.data.organizationId) &&
                       (
                         (request.auth.uid == request.resource.data.userId && request.resource.data.status == 'draft') ||
                         isManage()
                       );
      
      // アルバイトは自分のタイムカードを以下の条件で更新可能
      // - status=draftの間は自由に更新可能（statusをdraftからpendingに変更することも含む）
      // - rejectedからdraftへの巻き戻しも可能
      // - 打刻フィールド（clockInAt, clockOutAt, breakStartAt, breakEndAt, updatedAt）のみの更新は、statusに関係なく可能
      // 管理者は組織内の任意のタイムカードを更新可能
      // ただし、status=approvedの場合は管理者でもpendingへの差し戻しのみ許可
      allow update: if signedIn() && 
                       isMember(resource.data.organizationId) &&
                       (
                         // 管理者による差し戻し: approved → pending のみ許可
                         (
                           isManage() &&
                           resource.data.status == 'approved' &&
                           request.resource.data.status == 'pending' &&
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt'])
                         ) ||
                         // 管理者による通常の更新: approved以外
                         (
                           isManage() &&
                           resource.data.status != 'approved'
                         ) ||
                         // アルバイトによる更新: approved以外
                         (
                           request.auth.uid == resource.data.userId &&
                           resource.data.status != 'approved' &&
                           (
                             (resource.data.status == 'draft') ||
                             (resource.data.status == 'rejected' && request.resource.data.status == 'draft') ||
                             (
                               // 打刻フィールドのみの変更を許可（statusは変更しない）
                               request.resource.data.status == resource.data.status &&
                               request.resource.data.diff(resource.data).affectedKeys().hasOnly(['clockInAt', 'clockOutAt', 'breakStartAt', 'breakEndAt', 'updatedAt'])
                             )
                           )
                         )
                       );
      
      // 管理者は同じ組織のタイムカードを削除可能（承認済みでない）
      allow delete: if signedIn() && 
                       isMember(resource.data.organizationId) && 
                       isManage() &&
                       resource.data.status != 'approved';
    }
    
    // 月次レポートコレクション
    match /monthlyReports/{reportId} {
      // 読み取り: 管理者のみ（存在しないドキュメントの読み取りも許可）
      allow read: if signedIn() && 
                     isManage();
      
      // 作成・更新: 管理者のみ
      allow create, update: if signedIn() && 
                               request.resource.data.organizationId != null &&
                               isMember(request.resource.data.organizationId) &&
                               isManage();
      
      // 削除: 管理者のみ
      allow delete: if signedIn() && 
                       resource.data.organizationId != null &&
                       isMember(resource.data.organizationId) && 
                       isManage();
    }
  }
}